---

- name: Create Alias
  uri:
    url: "https://{{ mailcow__hostname }}/api/v1/add/alias"
    method: POST
    body_format: json
    return_content: yes
    status_code: 403
    body: "{{ mailcow__demo_alias__read_only_json | to_json }}"
    headers:
      X-API-Key: "{{ mailcow__api_key_read_only }}"
  register: result_alias_read_only
  until: ('json' in result_alias_read_only)
  retries: 10
  delay: 10
  ignore_errors: yes

- name: Debug Creation
  debug:
    var: result_alias_read_only.json

- set_fact:
    result_alias_read_only_success: success
  when: ('json' in result_alias_read_only) and ("API read/write access denied" in result_alias_read_only.json[0].msg)

- set_fact:
    result_alias_read_only_success: failed
  when: ('json' in result_alias_read_only) and ("API read/write access denied" not in result_alias_read_only.json[0].msg)

- name: Get Alias
  uri:
    url: "https://{{ mailcow__hostname }}/api/v1/get/alias/all"
    method: GET
    body_format: json
    return_content: yes
    status_code: 200
    headers:
      X-API-Key: "{{ mailcow__api_key_read_only }}"
  register: result_alias_get_read_only
  until:
    - ('json' in result_alias_get_read_only)
  retries: 10
  delay: 10

- name: Debug Get
  debug:
    var: result_alias_get_read_only.json

- set_fact:
    result_alias_read_only_get_success: success
  when: ('json' in result_alias_get_read_only) and (result_alias_get_read_only.json[0] is defined)

- set_fact:
    result_alias_read_only_get_success: failed
  when: ('json' in result_alias_get_read_only) and (result_alias_get_read_only.json[0] is not defined)
